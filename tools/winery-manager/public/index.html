<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FLXguide Winery Manager</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; }

        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        h1 { color: #2c3e50; margin-bottom: 20px; }

        /* Stats */
        .stats { display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; }
        .stat-card { background: white; padding: 15px 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); min-width: 140px; }
        .stat-card h3 { font-size: 24px; color: #2c3e50; }
        .stat-card p { color: #666; font-size: 12px; text-transform: uppercase; }
        .stat-card.green h3 { color: #27ae60; }
        .stat-card.yellow h3 { color: #f39c12; }
        .stat-card.red h3 { color: #e74c3c; }

        /* Controls */
        .controls { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; align-items: center; }
        .controls input[type="text"] { padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; width: 250px; }
        .controls select { padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; }
        .btn { padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; }
        .btn-primary { background: #3498db; color: white; }
        .btn-primary:hover { background: #2980b9; }
        .btn-success { background: #27ae60; color: white; }
        .btn-success:hover { background: #229954; }
        .btn-danger { background: #e74c3c; color: white; }
        .btn-danger:hover { background: #c0392b; }
        .btn-secondary { background: #95a5a6; color: white; }
        .btn-secondary:hover { background: #7f8c8d; }

        /* Table */
        .table-container { background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); overflow: hidden; }
        table { width: 100%; border-collapse: collapse; }
        th { background: #34495e; color: white; padding: 12px; text-align: left; cursor: pointer; user-select: none; }
        th:hover { background: #2c3e50; }
        th .sort-indicator { margin-left: 5px; opacity: 0.5; }
        td { padding: 10px 12px; border-bottom: 1px solid #eee; }
        tr:hover { background: #f8f9fa; }
        tr.status-found { border-left: 4px solid #27ae60; }
        tr.status-multiple_matches { border-left: 4px solid #f39c12; }
        tr.status-not_found, tr.status-error { border-left: 4px solid #e74c3c; }
        tr.status-manually_verified { border-left: 4px solid #3498db; }

        /* Status badges */
        .status-badge { padding: 3px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; text-transform: uppercase; }
        .status-badge.found { background: #d4edda; color: #155724; }
        .status-badge.multiple_matches { background: #fff3cd; color: #856404; }
        .status-badge.not_found, .status-badge.error { background: #f8d7da; color: #721c24; }
        .status-badge.manually_verified { background: #cce5ff; color: #004085; }

        /* Completeness bar */
        .completeness { display: flex; align-items: center; gap: 8px; }
        .completeness-bar { width: 60px; height: 8px; background: #eee; border-radius: 4px; overflow: hidden; }
        .completeness-fill { height: 100%; border-radius: 4px; }
        .completeness-fill.high { background: #27ae60; }
        .completeness-fill.medium { background: #f39c12; }
        .completeness-fill.low { background: #e74c3c; }

        /* Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .modal { background: white; border-radius: 8px; width: 700px; max-height: 90vh; overflow-y: auto; }
        .modal-header { padding: 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .modal-header h2 { margin: 0; }
        .modal-body { padding: 20px; }
        .modal-footer { padding: 15px 20px; border-top: 1px solid #eee; display: flex; justify-content: flex-end; gap: 10px; }

        /* Form */
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 600; color: #333; font-size: 13px; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 8px 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; }
        .form-group textarea { resize: vertical; min-height: 80px; }
        .form-row { display: flex; gap: 15px; }
        .form-row .form-group { flex: 1; }
        .form-group.small { flex: 0.5; }

        /* Hours display */
        .hours-list { font-size: 12px; line-height: 1.6; background: #f8f9fa; padding: 10px; border-radius: 4px; }

        /* Links */
        a { color: #3498db; text-decoration: none; }
        a:hover { text-decoration: underline; }

        /* Clickable row */
        tr { cursor: pointer; }

        /* Loading */
        .loading { text-align: center; padding: 40px; color: #666; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // Field definitions for completeness calculation
        const COMPLETENESS_FIELDS = ['address', 'coordinates', 'phone', 'website', 'hours', 'googleRating'];

        function App() {
            const [data, setData] = useState(null);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [search, setSearch] = useState('');
            const [statusFilter, setStatusFilter] = useState('all');
            const [sortField, setSortField] = useState('name');
            const [sortDir, setSortDir] = useState('asc');
            const [editingIndex, setEditingIndex] = useState(null);
            const [editForm, setEditForm] = useState(null);

            // Load data
            useEffect(() => {
                fetchData();
            }, []);

            const fetchData = async () => {
                try {
                    const response = await fetch('/api/wineries');
                    const json = await response.json();
                    setData(json);
                    setLoading(false);
                } catch (err) {
                    setError(err.message);
                    setLoading(false);
                }
            };

            // Calculate completeness
            const getCompleteness = (winery) => {
                const filled = COMPLETENESS_FIELDS.filter(f => {
                    if (f === 'coordinates') return winery.coordinates?.lat && winery.coordinates?.lng;
                    return winery[f] != null && winery[f] !== '';
                }).length;
                return Math.round((filled / COMPLETENESS_FIELDS.length) * 100);
            };

            // Stats
            const stats = useMemo(() => {
                if (!data?.wineries) return null;
                const wineries = data.wineries;
                const withWebsite = wineries.filter(w => w.website).length;
                const withPhone = wineries.filter(w => w.phone).length;
                const withHours = wineries.filter(w => w.hours).length;
                return {
                    total: wineries.length,
                    found: wineries.filter(w => w.verificationStatus === 'found').length,
                    multipleMatches: wineries.filter(w => w.verificationStatus === 'multiple_matches').length,
                    notFound: wineries.filter(w => w.verificationStatus === 'not_found').length,
                    errors: wineries.filter(w => w.verificationStatus === 'error').length,
                    manuallyVerified: wineries.filter(w => w.verificationStatus === 'manually_verified').length,
                    withWebsite,
                    withPhone,
                    withHours
                };
            }, [data]);

            // Filtered and sorted wineries
            const filteredWineries = useMemo(() => {
                if (!data?.wineries) return [];
                let result = [...data.wineries];

                // Filter by status
                if (statusFilter !== 'all') {
                    result = result.filter(w => w.verificationStatus === statusFilter);
                }

                // Filter by search
                if (search) {
                    const s = search.toLowerCase();
                    result = result.filter(w =>
                        w.name?.toLowerCase().includes(s) ||
                        w.address?.toLowerCase().includes(s) ||
                        w.originalSearchName?.toLowerCase().includes(s)
                    );
                }

                // Sort
                result.sort((a, b) => {
                    let aVal = a[sortField] ?? '';
                    let bVal = b[sortField] ?? '';
                    if (sortField === 'completeness') {
                        aVal = getCompleteness(a);
                        bVal = getCompleteness(b);
                    }
                    if (typeof aVal === 'string') aVal = aVal.toLowerCase();
                    if (typeof bVal === 'string') bVal = bVal.toLowerCase();
                    if (aVal < bVal) return sortDir === 'asc' ? -1 : 1;
                    if (aVal > bVal) return sortDir === 'asc' ? 1 : -1;
                    return 0;
                });

                return result.map(w => ({ ...w, _originalIndex: data.wineries.indexOf(w) }));
            }, [data, search, statusFilter, sortField, sortDir]);

            // Sort handler
            const handleSort = (field) => {
                if (sortField === field) {
                    setSortDir(sortDir === 'asc' ? 'desc' : 'asc');
                } else {
                    setSortField(field);
                    setSortDir('asc');
                }
            };

            // Edit handlers
            const openEdit = (winery, index) => {
                setEditingIndex(index);
                setEditForm({ ...winery });
            };

            const closeEdit = () => {
                setEditingIndex(null);
                setEditForm(null);
            };

            const handleFormChange = (field, value) => {
                setEditForm(prev => ({ ...prev, [field]: value }));
            };

            const handleCoordChange = (field, value) => {
                setEditForm(prev => ({
                    ...prev,
                    coordinates: { ...prev.coordinates, [field]: parseFloat(value) || null }
                }));
            };

            const saveEdit = async () => {
                try {
                    const response = await fetch(`/api/wineries/${editingIndex}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(editForm)
                    });
                    if (response.ok) {
                        await fetchData();
                        closeEdit();
                    }
                } catch (err) {
                    alert('Failed to save: ' + err.message);
                }
            };

            const addNew = async () => {
                try {
                    const response = await fetch('/api/wineries', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name: 'New Winery' })
                    });
                    const result = await response.json();
                    if (response.ok) {
                        await fetchData();
                        openEdit(result.winery, result.index);
                    }
                } catch (err) {
                    alert('Failed to add: ' + err.message);
                }
            };

            const deleteWinery = async () => {
                if (!confirm('Are you sure you want to delete this winery?')) return;
                try {
                    const response = await fetch(`/api/wineries/${editingIndex}`, { method: 'DELETE' });
                    if (response.ok) {
                        await fetchData();
                        closeEdit();
                    }
                } catch (err) {
                    alert('Failed to delete: ' + err.message);
                }
            };

            if (loading) return <div className="container"><div className="loading">Loading wineries...</div></div>;
            if (error) return <div className="container"><div className="loading">Error: {error}</div></div>;

            return (
                <div className="container">
                    <h1>FLXguide Winery Manager</h1>

                    {/* Stats */}
                    <div className="stats">
                        <div className="stat-card">
                            <h3>{stats.total}</h3>
                            <p>Total Wineries</p>
                        </div>
                        <div className="stat-card green">
                            <h3>{stats.found}</h3>
                            <p>Found</p>
                        </div>
                        <div className="stat-card yellow">
                            <h3>{stats.multipleMatches}</h3>
                            <p>Multiple Matches</p>
                        </div>
                        <div className="stat-card red">
                            <h3>{stats.notFound + stats.errors}</h3>
                            <p>Not Found / Errors</p>
                        </div>
                        <div className="stat-card">
                            <h3>{stats.withWebsite}/{stats.total}</h3>
                            <p>Have Website</p>
                        </div>
                        <div className="stat-card">
                            <h3>{stats.withPhone}/{stats.total}</h3>
                            <p>Have Phone</p>
                        </div>
                        <div className="stat-card">
                            <h3>{stats.withHours}/{stats.total}</h3>
                            <p>Have Hours</p>
                        </div>
                    </div>

                    {/* Controls */}
                    <div className="controls">
                        <input
                            type="text"
                            placeholder="Search wineries..."
                            value={search}
                            onChange={(e) => setSearch(e.target.value)}
                        />
                        <select value={statusFilter} onChange={(e) => setStatusFilter(e.target.value)}>
                            <option value="all">All Status</option>
                            <option value="found">Found</option>
                            <option value="multiple_matches">Multiple Matches</option>
                            <option value="not_found">Not Found</option>
                            <option value="error">Error</option>
                            <option value="manually_verified">Manually Verified</option>
                        </select>
                        <button className="btn btn-success" onClick={addNew}>+ Add Winery</button>
                        <span style={{marginLeft: 'auto', color: '#666'}}>
                            Showing {filteredWineries.length} of {stats.total}
                        </span>
                    </div>

                    {/* Table */}
                    <div className="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th onClick={() => handleSort('name')}>
                                        Name {sortField === 'name' && <span className="sort-indicator">{sortDir === 'asc' ? '▲' : '▼'}</span>}
                                    </th>
                                    <th onClick={() => handleSort('address')}>
                                        Location {sortField === 'address' && <span className="sort-indicator">{sortDir === 'asc' ? '▲' : '▼'}</span>}
                                    </th>
                                    <th onClick={() => handleSort('verificationStatus')}>
                                        Status {sortField === 'verificationStatus' && <span className="sort-indicator">{sortDir === 'asc' ? '▲' : '▼'}</span>}
                                    </th>
                                    <th onClick={() => handleSort('googleRating')}>
                                        Rating {sortField === 'googleRating' && <span className="sort-indicator">{sortDir === 'asc' ? '▲' : '▼'}</span>}
                                    </th>
                                    <th>Phone</th>
                                    <th>Website</th>
                                    <th onClick={() => handleSort('completeness')}>
                                        Complete {sortField === 'completeness' && <span className="sort-indicator">{sortDir === 'asc' ? '▲' : '▼'}</span>}
                                    </th>
                                </tr>
                            </thead>
                            <tbody>
                                {filteredWineries.map((winery) => {
                                    const completeness = getCompleteness(winery);
                                    const city = winery.address?.split(',')[1]?.trim() || '';
                                    return (
                                        <tr
                                            key={winery._originalIndex}
                                            className={`status-${winery.verificationStatus}`}
                                            onClick={() => openEdit(winery, winery._originalIndex)}
                                        >
                                            <td><strong>{winery.name}</strong></td>
                                            <td>{city}</td>
                                            <td>
                                                <span className={`status-badge ${winery.verificationStatus}`}>
                                                    {winery.verificationStatus?.replace('_', ' ')}
                                                </span>
                                            </td>
                                            <td>{winery.googleRating ? `${winery.googleRating} ★` : '-'}</td>
                                            <td>{winery.phone || '-'}</td>
                                            <td>
                                                {winery.website ? (
                                                    <a href={winery.website} target="_blank" onClick={(e) => e.stopPropagation()}>Link</a>
                                                ) : '-'}
                                            </td>
                                            <td>
                                                <div className="completeness">
                                                    <div className="completeness-bar">
                                                        <div
                                                            className={`completeness-fill ${completeness >= 80 ? 'high' : completeness >= 50 ? 'medium' : 'low'}`}
                                                            style={{width: `${completeness}%`}}
                                                        />
                                                    </div>
                                                    <span>{completeness}%</span>
                                                </div>
                                            </td>
                                        </tr>
                                    );
                                })}
                            </tbody>
                        </table>
                    </div>

                    {/* Edit Modal */}
                    {editForm && (
                        <div className="modal-overlay" onClick={closeEdit}>
                            <div className="modal" onClick={(e) => e.stopPropagation()}>
                                <div className="modal-header">
                                    <h2>Edit Winery</h2>
                                    <button className="btn btn-secondary" onClick={closeEdit}>×</button>
                                </div>
                                <div className="modal-body">
                                    <div className="form-row">
                                        <div className="form-group">
                                            <label>Name</label>
                                            <input
                                                type="text"
                                                value={editForm.name || ''}
                                                onChange={(e) => handleFormChange('name', e.target.value)}
                                            />
                                        </div>
                                        <div className="form-group">
                                            <label>Original Search Name</label>
                                            <input
                                                type="text"
                                                value={editForm.originalSearchName || ''}
                                                onChange={(e) => handleFormChange('originalSearchName', e.target.value)}
                                            />
                                        </div>
                                    </div>

                                    <div className="form-group">
                                        <label>Address</label>
                                        <input
                                            type="text"
                                            value={editForm.address || ''}
                                            onChange={(e) => handleFormChange('address', e.target.value)}
                                        />
                                    </div>

                                    <div className="form-row">
                                        <div className="form-group small">
                                            <label>Latitude</label>
                                            <input
                                                type="number"
                                                step="any"
                                                value={editForm.coordinates?.lat || ''}
                                                onChange={(e) => handleCoordChange('lat', e.target.value)}
                                            />
                                        </div>
                                        <div className="form-group small">
                                            <label>Longitude</label>
                                            <input
                                                type="number"
                                                step="any"
                                                value={editForm.coordinates?.lng || ''}
                                                onChange={(e) => handleCoordChange('lng', e.target.value)}
                                            />
                                        </div>
                                        <div className="form-group small">
                                            <label>Phone</label>
                                            <input
                                                type="text"
                                                value={editForm.phone || ''}
                                                onChange={(e) => handleFormChange('phone', e.target.value)}
                                            />
                                        </div>
                                    </div>

                                    <div className="form-group">
                                        <label>Website</label>
                                        <input
                                            type="text"
                                            value={editForm.website || ''}
                                            onChange={(e) => handleFormChange('website', e.target.value)}
                                        />
                                    </div>

                                    <div className="form-row">
                                        <div className="form-group small">
                                            <label>Google Rating</label>
                                            <input
                                                type="number"
                                                step="0.1"
                                                min="0"
                                                max="5"
                                                value={editForm.googleRating || ''}
                                                onChange={(e) => handleFormChange('googleRating', parseFloat(e.target.value) || null)}
                                            />
                                        </div>
                                        <div className="form-group small">
                                            <label>Review Count</label>
                                            <input
                                                type="number"
                                                value={editForm.reviewCount || ''}
                                                onChange={(e) => handleFormChange('reviewCount', parseInt(e.target.value) || null)}
                                            />
                                        </div>
                                        <div className="form-group">
                                            <label>Verification Status</label>
                                            <select
                                                value={editForm.verificationStatus || 'found'}
                                                onChange={(e) => handleFormChange('verificationStatus', e.target.value)}
                                            >
                                                <option value="found">Found</option>
                                                <option value="multiple_matches">Multiple Matches</option>
                                                <option value="not_found">Not Found</option>
                                                <option value="error">Error</option>
                                                <option value="manually_verified">Manually Verified</option>
                                            </select>
                                        </div>
                                    </div>

                                    <div className="form-group">
                                        <label>Place ID</label>
                                        <input
                                            type="text"
                                            value={editForm.placeId || ''}
                                            onChange={(e) => handleFormChange('placeId', e.target.value)}
                                        />
                                    </div>

                                    <div className="form-group">
                                        <label>Google Maps URL</label>
                                        <input
                                            type="text"
                                            value={editForm.googleMapsUrl || ''}
                                            onChange={(e) => handleFormChange('googleMapsUrl', e.target.value)}
                                        />
                                    </div>

                                    {editForm.hours && (
                                        <div className="form-group">
                                            <label>Hours</label>
                                            <div className="hours-list">
                                                {editForm.hours.map((h, i) => <div key={i}>{h}</div>)}
                                            </div>
                                        </div>
                                    )}

                                    <div className="form-group">
                                        <label>Notes</label>
                                        <textarea
                                            value={editForm.notes || ''}
                                            onChange={(e) => handleFormChange('notes', e.target.value)}
                                            placeholder="Add your own notes here..."
                                        />
                                    </div>

                                    <div className="form-row" style={{fontSize: '12px', color: '#666'}}>
                                        <div className="form-group">
                                            <label>Collected At</label>
                                            <div>{editForm.collectedAt || 'N/A'}</div>
                                        </div>
                                        <div className="form-group">
                                            <label>Last Modified</label>
                                            <div>{editForm.lastModified || 'N/A'}</div>
                                        </div>
                                    </div>
                                </div>
                                <div className="modal-footer">
                                    <button className="btn btn-danger" onClick={deleteWinery}>Delete</button>
                                    <button className="btn btn-secondary" onClick={closeEdit}>Cancel</button>
                                    <button className="btn btn-primary" onClick={saveEdit}>Save Changes</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
